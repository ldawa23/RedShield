---
# RedShield Ansible Playbook: Fix Default Credentials
# Replaces default passwords with secure random ones
#
# Usage: ansible-playbook fix_default_credentials.yml -e "target_host=192.168.1.100 service_name=mysql"

- name: Fix Default Credentials
  hosts: "{{ target_host | default('localhost') }}"
  become: yes
  vars:
    service_name: "{{ service_name | default('mysql') }}"
    backup_dir: "/tmp/redshield_backups"
    
  tasks:
    - name: Create backup directory
      file:
        path: "{{ backup_dir }}"
        state: directory
        mode: '0755'

    - name: Generate secure random password
      shell: openssl rand -base64 24 | tr -d '/+=' | head -c 32
      register: new_password
      changed_when: false
      no_log: true

    - name: Display password info (masked)
      debug:
        msg: "New secure password generated ({{ new_password.stdout | length }} characters)"

    # MySQL specific tasks
    - name: Fix MySQL default credentials
      block:
        - name: Backup MySQL config
          copy:
            src: /etc/mysql/mysql.conf.d/mysqld.cnf
            dest: "{{ backup_dir }}/mysqld.cnf.bak.{{ ansible_date_time.date }}"
            remote_src: yes
          ignore_errors: yes

        - name: Update MySQL root password
          mysql_user:
            name: root
            password: "{{ new_password.stdout }}"
            host: localhost
            login_unix_socket: /var/run/mysqld/mysqld.sock
          ignore_errors: yes
          no_log: true

        - name: Save new credentials to secure file
          copy:
            content: |
              # RedShield Generated Credentials
              # Date: {{ ansible_date_time.iso8601 }}
              # Service: MySQL
              # WARNING: Store securely and delete this file
              MYSQL_ROOT_PASSWORD={{ new_password.stdout }}
            dest: "{{ backup_dir }}/mysql_credentials.txt"
            mode: '0600'
          no_log: true
      when: service_name == 'mysql'

    # PostgreSQL specific tasks
    - name: Fix PostgreSQL default credentials
      block:
        - name: Backup PostgreSQL config
          copy:
            src: /etc/postgresql/*/main/pg_hba.conf
            dest: "{{ backup_dir }}/pg_hba.conf.bak.{{ ansible_date_time.date }}"
            remote_src: yes
          ignore_errors: yes

        - name: Update PostgreSQL password
          become_user: postgres
          postgresql_user:
            name: postgres
            password: "{{ new_password.stdout }}"
          ignore_errors: yes
          no_log: true

        - name: Save new credentials to secure file
          copy:
            content: |
              # RedShield Generated Credentials
              # Date: {{ ansible_date_time.iso8601 }}
              # Service: PostgreSQL
              # WARNING: Store securely and delete this file
              POSTGRES_PASSWORD={{ new_password.stdout }}
            dest: "{{ backup_dir }}/postgres_credentials.txt"
            mode: '0600'
          no_log: true
      when: service_name == 'postgresql'

    # Redis specific tasks
    - name: Fix Redis default credentials
      block:
        - name: Backup Redis config
          copy:
            src: /etc/redis/redis.conf
            dest: "{{ backup_dir }}/redis.conf.bak.{{ ansible_date_time.date }}"
            remote_src: yes
          ignore_errors: yes

        - name: Set Redis password
          lineinfile:
            path: /etc/redis/redis.conf
            regexp: '^# requirepass'
            line: "requirepass {{ new_password.stdout }}"
            backup: yes
          notify: Restart Redis
          no_log: true

        - name: Save new credentials to secure file
          copy:
            content: |
              # RedShield Generated Credentials
              # Date: {{ ansible_date_time.iso8601 }}
              # Service: Redis
              # WARNING: Store securely and delete this file
              REDIS_PASSWORD={{ new_password.stdout }}
            dest: "{{ backup_dir }}/redis_credentials.txt"
            mode: '0600'
          no_log: true
      when: service_name == 'redis'

    # SSH specific tasks
    - name: Fix SSH default/weak credentials
      block:
        - name: Disable root login via SSH
          lineinfile:
            path: /etc/ssh/sshd_config
            regexp: '^PermitRootLogin'
            line: 'PermitRootLogin no'
            backup: yes
          notify: Restart SSH

        - name: Disable password authentication (use keys only)
          lineinfile:
            path: /etc/ssh/sshd_config
            regexp: '^PasswordAuthentication'
            line: 'PasswordAuthentication no'
          notify: Restart SSH
      when: service_name == 'ssh'

    - name: Verify old default password no longer works
      debug:
        msg: "Credentials updated. Old default password should now be rejected."

  handlers:
    - name: Restart Redis
      service:
        name: redis
        state: restarted
      ignore_errors: yes

    - name: Restart SSH
      service:
        name: sshd
        state: restarted
      ignore_errors: yes
